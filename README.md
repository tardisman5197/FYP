# FYP Server

An API which gives a user access to a multi-agent traffic simulation with an optional unity visualisation attachment.

## Table of contents
1. [Getting Started](#getting-started)
    1. [Prerequisites](#prerequisites)
    2. [Configuring the project](#configuring-the-project)
    3. [Building the project](#building-the-project)
2. [Running the project](#running-the-project)
    1. [Using a build](#using-a-build)
    2. [Without a build](#without-a-build)
3. [API Endpoints](#api-endpoints)


## Getting Started
 
These instructions will get help you get the API up and running.

### Prerequisites

1. [Install Go](https://golang.org/doc/install)

2. Run the commands below, to install the project's dependencies

```
go get github.com/gorilla/handlers
go get github.com/gorilla/mux
go get github.com/sirupsen/logrus
go get github.com/fogleman/gg
go get github.com/jonas-p/go-shp
```

3. Create a Unity executable, details of how to achive this can be found [here](https://github.com/tardisman5197/FYP-Unity)

### Configuring the project

Within the project folder there are a few `config.go` files that will need to be changed before the project can run.

####  `config.go`

Within this file there are 2 contants that can be altered.

 * `serverAddr` - this is the port that the API will be accessed thourgh

 * `unityAddr` - this is the port that the unity server will be running on

#### `controller/config.go`

This config file is used to define trhe behaviour of the API.

* `keyLength` - this determines how long the unique string assigned to a simulation should be

* `sendBase64Encoding` - this should be set to true if the API should send a Base64 encoded string containing the information about the image created

#### `simulation/config.go`
This file contains paramaters that can change how a simulation is ran.

* `decelerationProbability` - this number is used to determin if a vehicle might slow down even if there are no obsticles ahead. THis value should be set between [0, 1]

* `margin` - this number determins how far apart vehicles should stay

#### `view/config.go`
This file contains all of the necessary paramters to allow the server to visulaise the simulation using unity.

* `pathToUnity` - this variable should be set to the file path towards the [unity executable](https://github.com/tardisman5197/FYP-Unity)

* `pathToImages` - this variable stores the location of where the unity application is deposition the images it generates

* `removeImagesOnShutdown` - this constant is true if the images generated by the unity instance should be removed when the server shutsdown. This should be set to true if you do not need to keep the images and do not have a lot of disk space.

* `startUnity` - this constant is set to true if a unity applictaion should be started when the server starts. When debugging or developing the unity application this should be set to true and an independant unity application should be started

### Building the project

To create an executable run the command from within the project folder.

```
go build
```

## Running the project

Once the project is running the API will be accessable through the port configured (default = ":8080").

### Using a build

After [building the project](#building-the-project), simply run the executable file.

### Without a build

To run the project without creating an executable can be achived by running the command below from within the project folder.

```
go run *.go
```


## API Endpoints

### Shutdown
Shutdown is used to start a graceful shutdown of the server. After this is called
the server will no longer accept requests and all simulations will be removed.

#### Endpoint
`GET ”/shutdown”`

### New Simulation
New Simulation is used to create a new traffic simulation with given parameters. When a simulation is created a unique id is assigned. This id is then required in subsequent requests to identify the simulation.

#### Endpoint
`POST ”/simulation/new”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
 Environment | `string` | The file path to the shape file that describes the environment for the simulation.
Lights | `[][]float64` | An array of positions composed of an x and y coordinate. This list of positions is used to create lights in the positions given.

#### Response

Parameter | Type | Value
--- | --- | ---
Key | `string` | The unique id assigned to the simulation created.
Success | `Boolean` | True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.

### Remove Simulation
Remove simulation deletes a specified simulation from the server. After a simulation is removed information about the simulation can no longer be accessed.

#### Endpoint
`GET ”/simulation/remove/<id>”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
ID | `string` | The unique string assigned to the simulation you want to access.
#### Response

Parameter | Type | Value
--- | --- | ---
Success | `Boolean` | True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.

### Run Simulation
Run Simulation is used to execute a specified amount of time for a given simulation. The response to this request is sent once the simulation has been executed for the amount of ticks specified and can take a long time.

#### Endpoint
`POST ”/simulation/run/<id>”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
ID | `string` | The unique string assigned to the simulation you want to access.
Steps | `integer` | The number of steps the simulation should be executed for.

#### Response

Parameter | Type | Value
--- | --- | ---
Success | `Boolean` | True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.

### Add Agent
Add agent involves defining an agent to be added to the simulation specified.
Once the agent is sent to the simulation it is assigned a unique id, which can be later used to get information about the agent in the simulation.

#### Endpoint
`POST ”/simulation/add/<id>”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
ID | `string` | The unique string assigned to the simulation you want to access.
StartLocation | `[]float64` | Start location contains the x and y coordinate that the agent should start at.
StartSpeed | `float64` | Start speed is the initial speed given to the agent when it is added to the simulation.
MaxSpeed | `float64` | Max speed is the highest speed that an agent can reach.
Acceleration | `float64` | Acceleration is the amount the speed of the agent can increase in one tick of the simulation.
Deceleration | `float64` | Deceleration is the amount the speed of the agent can decrease in one tick of the simulation.
Route | `[][]float64` | Route contains a list of x and y coordinates of the waypoints that the agent must visit.
Type | `string` | Type is used to determine what type of agent is added to the simulation, for example ”vehicle” might be specified.
Frequency | `int` | Frequency determines how often an instance of the agent is added to the simulation. An agent with a frequency 0 will only spawn once, however an agent with frequency 3 will spawn every 3rd tick of the simulation.

#### Response

Parameter | Type | Value
--- | --- | ---
Success | `Boolean` | True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.

### Add Light
Add light is used to add a traffic light to the simulation. Once added information about the state of the light can be retrieved and the state of the light can be changed.

#### Endpoint
`POST ”/simulation/light/add/<id>”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
ID | `string` | The unique string assigned to the simulation you want to access.
Position | `[]float64` | Position is the x and y coordinate that the light should be placed at.
Stop | `Boolean` | Stop is true if agents should stop when they meet the light. If stop is false agents will pass by the light.

#### Response

Parameter | Type | Value
--- | --- | ---
Success | `Boolean` |True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.

### Update Light
Update light is used to change the state of a traffic light within a specified simulation.

#### Endpoint
`POST ”/simulation/light/update/<id>”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
ID | `string` | The unique string assigned to the simulation you want to access.
ID | `int` | The unique int assigned to the light that is wanting to be changed.
Stop | `Boolean` | Stop is true if agents should stop when they meet the light. If stop is false agents will pass by the light.

#### Response

Parameter | Type | Value
--- | --- | ---
Success | `Boolean` | True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.

### Agent Info
Agent info is used to get the information about a specified agent in a simulation.

#### Endpoint
`GET ”/simulation/info/agent/<id>/<agent-id>”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
ID  | `string` | The unique string assigned to the simulation you want to access.
Agent-ID | `int` | The unique int assigned to the agent.

#### Response

Parameter | Type | Value
--- | --- | ---
Success | `Boolean` | True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.
Info | `Agent Object` | The object containing the information about an agent.

### Simulation Info
Simulation info is used to get the information about a specified simulation.

#### Endpoint
`GET ”/simulation/info/<id>”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
ID | `string` | The unique string assigned to the simulation you want to access.

#### Response

Parameter | Type | Value
--- | --- | ---
Success | `Boolean` | True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.
Info | `Simulation Object` | The object containing the information about a simulation.

### Simulation Image
Simulation image is used to generate an image based on the current state of a
specified simulation.

#### Endpoint
`POST ”/simulation/view/<id>”`

#### Parameters

Parameter | Type | Value
--- | --- | ---
ID | `string` | The unique string assigned to the simulation you want to access.
Camera Position | `[]float64` | Camera position contains coordinates of where the camera should be placed in the simulation.
Camera Direction | `[]float64` | Camera direction is the coordinates of a point in the simulation which the camera should be looking towards.

#### Response

Parameter | Type | Value
--- | --- | ---
Success | `Boolean` | True if the command was successfully executed. If this value is false the error parameter will provide an explanation.
Error | `string` | If Success is false, this string will contain the explanation for why the command did not execute correctly.
Filepath | `string` | File path contains the path to the image generated.
Image | `string` | Image contains a base64 encoded string representing the image generated.

### Objects

#### Simulation Object

Parameter | Type | Value
--- | --- | ---
Agents | `[]Agent Object` | Agents stores a list of information about all the agents within the simulation.
Environment | `Environment Object` | Environment stores the information about the simulation’s environment.
Tick | `int` | Tick stores the current tick of the simulation specified.

#### Light Object

Parameter | Type | Value
--- | --- | ---
Stop | `Boolean` | Stop contains the current state of the light’s stop variable.
Position | `[]float64` | Position contains the location of the traffic light.
ID | `int` | Id contains the unique id assigned to the traffic light by the simulation.

#### Environment Object

Parameter | Type | Value
--- | --- | ---
Waypoints | `[][]float64` | Waypoints contain the list of points that make up the road network.
Lights | `[]Light Object` | Lights store a list of information about all the lights in the simulation.

#### Agent Object

Parameter | Type | Value
--- | --- | ---
ID | `int` | The unique id given by the simulation to the agent.
Position | `[]float64` |Position stores the current position of the agent.
Speed | `float64` | Speed contains the current speed of the agent in the simulation.
CurrentWaypoint | `[]float64` | Current waypoint stores the location which the agent is currently traveling towards.
Route | `[][]float64` | Route contains a list of coordinates which the agent should pass through.
Type | `string` | Type is a string storing what type of agent it is.